<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.bobj.funding.mapper.FundingOrderMapper">

  <!-- 내가 투자한 주문 리스트 -->
  <select id="findFundingOrdersByUserId" resultMap="FundingOrderUserMap">
    SELECT
        p.property_id AS property_id,
        p.title,
        f.funding_id AS funding_id,
        fo.status,
        f.target_amount,
        f.current_amount,
        FLOOR((f.current_amount / f.target_amount) * 100) AS achievement_rate,
        (f.target_amount - f.current_amount) / 5000 AS remaining_shares,
        (f.target_amount - f.current_amount) AS remaining_amount,
        fo.order_id,
        fo.order_price,
        fo.share_count,
        (SELECT photo_url
        FROM property_photos
        WHERE property_id = p.property_id
        ORDER BY created_at ASC
        LIMIT 1) AS thumbnail_url
    FROM funding_order fo
           JOIN fundings f ON fo.funding_id = f.funding_id
           JOIN properties p ON f.property_id = p.property_id
    WHERE fo.user_id = #{userId}
      AND fo.status != 'SUCCESS'
    ORDER BY fo.created_at DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>
  <resultMap id="FundingOrderUserMap" type="org.bobj.funding.dto.FundingOrderUserResponseDTO">
    <id property="propertyId" column="property_id"/>
    <id property="fundingId" column="funding_id"/>
    <id property="orderId" column="order_id"/>
    <result property="title" column="title"/>
    <result property="status" column="status"/>
    <result property="shareCount" column="share_count"/>
    <result property="targetAmount" column="target_amount"/>
    <result property="currentAmount" column="current_amount"/>
    <result property="achievementRate" column="achievement_rate"/>
    <result property="remainingShares" column="remaining_shares"/>
    <result property="remainingAmount" column="remaining_amount"/>
    <result property="orderPrice" column="order_price"/>
    <association property="thumbnail" javaType="org.bobj.property.dto.PhotoDTO">
      <result property="photoUrl" column="thumbnail_url"/>
    </association>
  </resultMap>

  <!-- 펀딩 주문 생성 -->
  <insert id="insertFundingOrder">
    INSERT INTO funding_order (
      user_id, funding_id, share_count, order_price
    ) VALUES (#{userId}, #{fundingId}, #{shareCount}, #{shareCount} * 5000)
  </insert>

  <!-- 주문 취소 -->
  <update id="refundFundingOrder">
    UPDATE funding_order
    SET status = 'REFUNDED'
    WHERE order_id = #{orderId}
  </update>

    <!-- 주문 가능 정보 조회 -->
    <select id="findFundingOrderLimit" resultType="org.bobj.funding.dto.FundingOrderLimitDTO">
        SELECT
            5000 AS share_amount,

            -- 펀딩 관련
            f.target_amount - f.current_amount AS remaining_amount,
            (f.target_amount - f.current_amount) / 5000 AS remaining_shares,

            -- 유저 보유 주 수
            IFNULL((
                       SELECT SUM(fo.share_count)
                       FROM funding_order fo
                       WHERE fo.funding_id = f.funding_id
                         AND fo.user_id = #{userId}
                         AND fo.status = 'PENDING'
                   ), 0) AS user_share_count,

            -- 유저 포인트
            u.amount AS user_points

        FROM fundings f
                 JOIN points u ON u.user_id = #{userId}
        WHERE f.funding_id = #{fundingId}
    </select>

    <!-- 펀딩 ID에 해당하는 모든 주문 조회 -->
    <select id="findAllOrdersByFundingId" resultType="org.bobj.funding.domain.FundingOrderVO">
        SELECT order_id,
               user_id,
               funding_id,
               share_count,
               order_price,
               status,
               created_at
        FROM funding_order
        WHERE funding_id = #{fundingId}
    </select>

    <!-- 펀딩 ID에 해당하는 모든 주문 상태 변경 -->
    <update id="markOrdersAsSuccessByFundingId">
        UPDATE funding_order
        SET status = 'SUCCESS'
        WHERE funding_id = #{fundingId}
          AND status = 'PENDING'
    </update>

    <!-- 펀딩 ID에 해당하는 펀딩 주문 ID 리스트 조회 -->
    <select id="findFundingOrderIdsByFundingId" resultType="java.lang.Long">
        SELECT order_id
        FROM funding_order
        WHERE funding_id = #{fundingId}
    </select>

    <!-- 펀딩 주문 ID 리스트에 해당하는 펀딩 주문 데이터 status 수정 -->
    <update id="updateFundingOrderStatusToRefundedByOrderIds">
        UPDATE funding_order
        SET status = 'REFUNDED'
        WHERE order_id IN
        <foreach item="id" collection="orderIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

  <select id="findById" resultType="org.bobj.funding.domain.FundingOrderVO">
    SELECT order_id, user_id, order_price
    FROM funding_orders
    WHERE order_id = #{orderId}
  </select>

</mapper>